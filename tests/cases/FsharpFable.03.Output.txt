namespace Tests.FsharpFable
open Fable.SimpleJson
open Protokeep.FsharpFable
type ConvertDomain () =
    static member DefaultTrafficLight =
        lazy Domain.TrafficLight.Unknown
    static member TrafficLightFromString = function
        | "TrafficLightRed" -> Domain.TrafficLight.Red
        | "TrafficLightYellow" -> Domain.TrafficLight.Yellow
        | "TrafficLightGreen" -> Domain.TrafficLight.Green
        | _ -> Domain.TrafficLight.Unknown
    static member TrafficLightToString = function
        | Domain.TrafficLight.Red -> "TrafficLightRed"
        | Domain.TrafficLight.Yellow -> "TrafficLightYellow"
        | Domain.TrafficLight.Green -> "TrafficLightGreen"
        | _ -> "Unknown"
    static member DefaultCrossroad: Lazy<Domain.Crossroad> =
        lazy {
            Id = 0
            LongId = 0L
            AltId = System.Guid.Empty
            Street1 = ""
            Street2 = ""
            IsMonitored = false
            Xpos = 0.f
            Ypos = 0.
            Ratio = 0m
            LastChecked = System.DateTime.MinValue
            ServiceInterval = System.TimeSpan.Zero
            CurrentLight = ConvertDomain.DefaultTrafficLight.Value
            Nickname = None
            Img = Array.empty
            Notes = Array.empty
            Siblings = List.empty
            Props = Map.empty
        }
    static member CrossroadFromJson (json: Json): Domain.Crossroad =
        let mutable vId = 0
        let mutable vLongId = 0L
        let mutable vAltId = System.Guid.Empty
        let mutable vStreet1 = ""
        let mutable vStreet2 = ""
        let mutable vIsMonitored = false
        let mutable vXpos = 0.f
        let mutable vYpos = 0.
        let mutable vRatio = 0m
        let mutable vLastChecked = System.DateTime.MinValue
        let mutable vServiceInterval = System.TimeSpan.Zero
        let mutable vCurrentLight = ConvertDomain.DefaultTrafficLight.Value
        let mutable vNickname = None
        let mutable vImg = Array.empty
        let mutable vNotes = ResizeArray()
        let mutable vSiblings = ResizeArray()
        let mutable vProps = ResizeArray()
        getProps json
        |> Seq.iter(fun pair ->
            match pair.Key with
            | "Id" -> pair.Value |> ifNumber (fun v -> vId <- v |> unbox)
            | "LongId" -> pair.Value |> ifNumber (fun v -> vLongId <- v |> unbox)
            | "AltId" -> pair.Value |> ifString (fun v -> vAltId <- v |> System.Convert.FromBase64String |> System.Guid)
            | "Street1" -> pair.Value |> ifString (fun v -> vStreet1 <- v)
            | "Street2" -> pair.Value |> ifString (fun v -> vStreet2 <- v)
            | "IsMonitored" -> pair.Value |> ifBool (fun v -> vIsMonitored <- v)
            | "Xpos" -> pair.Value |> ifNumber (fun v -> vXpos <- v |> unbox)
            | "Ypos" -> pair.Value |> ifNumber (fun v -> vYpos <- v |> unbox)
            | "Ratio" -> pair.Value |> ifNumber (fun v -> vRatio <- v / 100. |> unbox)
            | "LastChecked" -> pair.Value |> ifString (fun v -> vLastChecked <- v |> toDateTime)
            | "ServiceInterval" -> pair.Value |> ifString (fun v -> vServiceInterval <- v |> toTimeSpan)
            | "CurrentLight" -> pair.Value |> ifString (fun v -> vCurrentLight <- v |> ConvertDomain.TrafficLightFromString)
            | "NicknameValue" -> pair.Value |> ifString (fun v -> vNickname <- v |> Some)
            | "Img" -> pair.Value |> ifString (fun v -> vImg <- v |> System.Convert.FromBase64String)
            | "Notes" -> pair.Value |> ifArray (Seq.iter (ifString (fun v -> v |> vNotes.Add)))
            | "Siblings" -> pair.Value |> ifArray (Seq.iter (ifNumber (fun v -> v |> unbox |> vSiblings.Add)))
            | "Props" -> pair.Value |> ifObject (Map.iter (fun key -> ifString (fun v -> v |> fun v -> vProps.Add(key, v))))
            | _ -> () )
        {
            Id = vId
            LongId = vLongId
            AltId = vAltId
            Street1 = vStreet1
            Street2 = vStreet2
            IsMonitored = vIsMonitored
            Xpos = vXpos
            Ypos = vYpos
            Ratio = vRatio
            LastChecked = vLastChecked
            ServiceInterval = vServiceInterval
            CurrentLight = vCurrentLight
            Nickname = vNickname
            Img = vImg
            Notes = unbox vNotes
            Siblings = vSiblings |> List.ofSeq
            Props = vProps |> Map.ofSeq
        }
    static member CrossroadToJson (x: Domain.Crossroad) =
        [
           "Id", JNumber (unbox x.Id)
           "LongId", JNumber (unbox x.LongId)
           "AltId", JString (x.AltId.ToByteArray() |> System.Convert.ToBase64String)
           "Street1", JString (x.Street1)
           "Street2", JString (x.Street2)
           "IsMonitored", JBool (x.IsMonitored)
           "Xpos", JNumber (unbox x.Xpos)
           "Ypos", JNumber (unbox x.Ypos)
           "Ratio", JNumber (x.Ratio * 100m |> System.Decimal.Truncate |> unbox)
           "LastChecked", JString (x.LastChecked |> fromDateTime)
           "ServiceInterval", JString (x.ServiceInterval |> fromTimeSpan)
           "CurrentLight", JString (x.CurrentLight |> ConvertDomain.TrafficLightToString)
           match x.Nickname with
           | Some v -> "NicknameValue", JString (v)
           | None -> ()
           "Img", JString (x.Img |> System.Convert.ToBase64String)
           "Notes", JArray (x.Notes |> Seq.map (fun v -> JString (v)) |> List.ofSeq)
           "Siblings", JArray (x.Siblings |> Seq.map (fun v -> JNumber (unbox v)) |> List.ofSeq)
           "Props", JObject (x.Props |> Map.map (fun _ v -> JString (v)))
        ] |> Map.ofList |> JObject
